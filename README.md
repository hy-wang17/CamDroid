# UUTestBot

## Build

UUTestBot is developed in Java using Android SDK (including some private internal APIs)
and can be compiled by a Java source compiler (e.g., `javac` or Eclipse JDT).
To run UUTestBot in an Android device, we need to convert the Java bytecode class files generated by a Java source compiler into dalvik bytecode.
We have built the SDK from [AOSP](https://source.android.com/) and put it as a library (see `dalvik_stub/` and `framework/`) in this project.

System requirements:

* Java 7 and above
* [Ant](http://ant.apache.org/)
* Dalvik compiler: `dx`
    * Add `$ANDROID_HOME/build-tools/<version>/` to your `PATH`

We used the old dalvik compiler `dx`, which is used in [APE](http://gutianxiao.com/ape/).
Developers may also want to use the new compiler [d8](https://developer.android.com/studio/command-line/d8) in the new SDK.

UUTestBot can be built by simply running `ant` or `ant assemble` in the root folder of the project (where the `build.xml` is.).
Developers can also clean the build by running `ant clean` first for a clean build.

## Development

This project can be loaded into `eclipse` for development since it is a pure Java project.
Remember to set the JDK compliance level to 1.7.

* Right click the project `monkey` in `Package Explorer`.
* Select `properties`.
* Click `Java Compiler` and make sure the compliance level is 1.7.

Developers may need to update the compliance when Android updates its JDK compliance of Java.

## Usage

If you have properly built UUTestBot, a file `ape.jar` will be generated in the root folder of the project.

Just copy the `ape.jar` to the phone:

`adb push ape.jar /data/local/tmp/`

and run

`adb shell CLASSPATH=/data/local/tmp/ape.jar /system/bin/app_process /data/local/tmp/ com.android.commands.monkey.Monkey`

We provide a python script (i.e., `ape.py`) to facilitate running UUTestBot on Android platform.

The following command starts to run UUTestBot to test the Calculator on a real device connected via adb. Make sure adb is available in your `PATH`.

`./ape.py -p com.google.android.calculator --running-minutes 100 --ape sata`

Check the `ape.py` if you want to run UUTestBot with multiple devices via `adb -s`.

Options:

* -p: specify the package name, the same as Monkey
* --running-minutes: the total testing time in minutes
	* This is the continuous mode, which means Ape does not stop when it triggers a crash.
* --ape sata: use the default exploration strategy described in the paper.
	* Only sata is supported now, where sata is the default exploration strategy described in [Fastbot2](https://github.com/bytedance/Fastbot_Android).
	* You can also specify the total amount of Monkey events. In this mode, Ape will stop by default once there is a crash.

## Support New Android Versions

UUTestBot is developed based on [APE](http://gutianxiao.com/ape/), which is implemented on top of some release of Android Marshmallow.
The easiest way to track the API changes of Ape is to check the change log of Monkey.
Since Monkey is no longer actively developed, one can easily identify patches/commits of Monkey that are related to API changes.

* Repository: <https://android.googlesource.com/platform/development/>
* Monkey folder: <https://android.googlesource.com/platform/development/+/refs/heads/master/cmds/monkey>

We do not want to build the new Android SDK to get its Java bytecode version after each new Android has been released.
We can use reflection APIs because these internal APIs are mostly invoked at the startup phase and should not be a performance bottleneck of UUTestBot.
More details can be found in source file `src/com/android/commands/monkey/ApeAPIAdapter.java`

In addition to private APIs used by Monkey, Ape also uses many new private APIs. We will use reflection to replace the direct usage of these APIs when these APIs have incompatible changes.

## Contact

* Yang Li (liyang14thu@gmail.com)
* Hongyi Wang (hongyi-w21@mails.tsinghua.edu.cn)